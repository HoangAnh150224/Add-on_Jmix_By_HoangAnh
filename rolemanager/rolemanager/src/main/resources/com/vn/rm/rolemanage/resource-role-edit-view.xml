<view xmlns="http://jmix.io/schema/flowui/view"
      title="Resource Role Editor">

    <data>
        <instance id="roleModelDc" class="io.jmix.security.model.ResourceRoleModel">
            <fetchPlan extends="_base">
                <property name="resourcePolicies" fetchPlan="_base"/>
            </fetchPlan>
            <collection id="resourcePoliciesDc" property="resourcePolicies"/>
        </instance>

        <collection id="entityMatrixDc"
                    class="com.vn.rm.rolemanage.entityfragment.EntityMatrixRow"/>
        <collection id="childRolesDc"
                    class="io.jmix.security.model.ResourceRoleModel"/>
        <collection id="policyTreeDc"
                    class="com.vn.rm.rolemanage.userinterfacefragment.PolicyGroupNode" />
        <collection id="specificDc"
                    class="com.vn.rm.rolemanage.specificfragment.SpecificNode" />
    </data>

    <facets>
        <settings auto="true"/>
        <dataLoadCoordinator auto="true"/>
    </facets>

    <actions>
        <action id="saveAction" type="detail_saveClose"/>
        <action id="closeAction" type="detail_close"/>
    </actions>

    <layout height="100%" expand="tabsBox">

        <!-- Form nhập liệu -->
        <vbox id="contentBox" width="100%" padding="false" spacing="false">
            <formLayout id="form" dataContainer="roleModelDc" width="100%">

                <!-- SỬA 2: Bỏ required="true" để Java tự bắt lỗi và hiển thị Notification -->
                <textField id="nameField" property="name" themeNames="small" label="Tên"/>

                <textField id="sourceField" property="source" readOnly="true" themeNames="small" label="Nguồn dữ liệu"/>

                <!-- SỬA 3: QUAN TRỌNG - Bỏ readOnly="true" để nhập được khi tạo mới -->
                <textField id="codeField" property="code" readOnly="true" label="Mã"/>

                <!-- SỬA 4: Bỏ required="true" để Java validation xử lý -->
                <checkboxGroup id="scopesField" property="scopes" readOnly="true"
                               themeNames="small helper-above-field"  label="Phạm vi" />

                <textArea id="descriptionField" property="description" height="6em" themeNames="small" label="Miêu tả"/>
            </formLayout>
        </vbox>

        <!-- Tabs -->
        <vbox id="tabsBox"
              width="100%"
              height="100%"
              expand="permissionsTabs">

            <tabSheet id="permissionsTabs" width="100%" height="100%">
                <tab id="entitiesTab" label="Thực thể &amp; Thuộc tính">
                    <vbox id="entitiesTabContent"
                          width="100%" height="100%"
                          expand="entitiesFragment"
                          padding="false" spacing="false">
                        <fragment id="entitiesFragment"
                                  class="com.vn.rm.rolemanage.entityfragment.EntitiesFragment"/>
                    </vbox>
                </tab>

                <tab id="uiTab" label="Giao diện người dùng">
                    <vbox id="uiTabContent"
                          width="100%" height="100%"
                          expand="userInterfaceFragment"
                          padding="false" spacing="false">
                        <fragment id="userInterfaceFragment"
                                  class="com.vn.rm.rolemanage.userinterfacefragment.UserInterfaceFragment"/>
                    </vbox>
                </tab>
                <tab id="specificTab" label="Quyền đặc thù">
                    <vbox id="specificTabContent"
                          width="100%" height="100%"
                          expand="specificFragment">
                        <fragment id="specificFragment"
                                  class="com.vn.rm.rolemanage.specificfragment.SpecificFragment"/>
                    </vbox>
                </tab>
                <tab id="childRolesTab" label="Vai trò cơ sở">
                    <vbox id="childRolesWrapper" padding="false" height="100%">
                        <hbox id="childRolesButtonsPanel" classNames="buttons-panel">
                            <button action="childRolesTable.add"/>
                            <button action="childRolesTable.remove"/>
                        </hbox>

                        <dataGrid id="childRolesTable"
                                  dataContainer="childRolesDc"
                                  selectionMode="MULTI"
                                  columnReorderingAllowed="true"
                                  width="100%">
                            <actions>
                                <!-- SỬA 5: Đổi type="list_add" thành icon="PLUS" để Java handle sự kiện mở Lookup -->
                                <action id="add" icon="PLUS" text="Add"/>
                                <action id="remove" type="list_remove">
                                    <properties>
                                        <property name="confirmation" value="false"/>
                                    </properties>
                                </action>
                            </actions>
                            <columns resizable="true">
                                <column property="name" flexGrow="2"/>
                                <column property="code"/>
                                <column property="source"/>
                            </columns>
                        </dataGrid>
                    </vbox>
                </tab>

            </tabSheet>
        </vbox>

        <!-- Actions Bar -->
        <hbox id="detailActions" classNames="px-m py-s bg-contrast-5" width="100%">
            <button id="saveAndCloseBtn" action="saveAction" themeNames="primary"/>
            <button id="closeBtn" action="closeAction"/>
        </hbox>
    </layout>
</view>